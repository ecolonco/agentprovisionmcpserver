# üè¢ Gu√≠a Completa de Integraci√≥n MCP Server para Comunigestor

## Sistema de Gesti√≥n de Condominios/Edificios

**Comunigestor** es un sistema completo de gesti√≥n de condominios con Django + React. El MCP Server puede potenciar TODAS las funcionalidades futuras y presentes.

---

## üìä Estado Actual de Comunigestor

### ‚úÖ Ya Implementado (Etapas 0, 1 y 2)
- Backend Django + DRF
- Autenticaci√≥n JWT (propia)
- Modelos: Community, Unit, Owner, Expense, Payment
- Sistema financiero completo
- Dashboard con estad√≠sticas
- Frontend React + Vite

### üöÄ Pendiente (Etapas 3-11)
- Comunicaciones (emails, SMS, portal)
- Pagos online (WebPay, Flow.cl)
- Bancos y cheques
- Personal y liquidaciones
- Medidores y servicios
- Documentos y notificaciones
- Reservas de espacios
- Tickets de soporte
- Proveedores
- App m√≥vil
- WhatsApp bot

---

## üí° TODAS las Aplicaciones del MCP Server para Comunigestor

### **1. üí≥ Sistema de Pagos Online (CR√çTICO)**

#### **A. Pago de Gastos Comunes con Flow.cl**

**Problema actual:**
- Residentes deben transferir manualmente
- Sin confirmaci√≥n autom√°tica de pago
- Administrador debe conciliar manualmente

**Soluci√≥n con MCP:**

```typescript
// Residente paga sus gastos comunes online
async function pagarGastoComun(unidadId, monto) {
  const pago = await mcpClient.createFlowPayment({
    amount: monto,  // Ej: $85.000 CLP
    subject: `Gasto Com√∫n - Unidad ${unidadId}`,
    customer_email: residente.email,
    payment_method: 1,  // Webpay
    url_return: 'https://comunigestor.com/payment-success',
    metadata: {
      unit_id: unidadId,
      community_id: comunidadId,
      payment_type: 'gasto_comun',
      month: '2024-11',
    },
  });

  // Flow procesa el pago
  // Webhook autom√°tico actualiza balance en Comunigestor
  // Estado de unidad cambia de "moroso" a "al_d√≠a"
}
```

**Beneficios:**
- ‚úÖ Pago instant√°neo 24/7
- ‚úÖ Confirmaci√≥n autom√°tica
- ‚úÖ Actualizaci√≥n de balance autom√°tica
- ‚úÖ Comprobante digital
- ‚úÖ Reducci√≥n de morosidad

---

#### **B. Suscripciones Mensuales para Gastos Comunes**

**Caso de uso:**
Residentes suscriben su tarjeta para pago autom√°tico mensual.

```typescript
// Residente configura d√©bito autom√°tico
async function configurarPagoAutomatico(unidadId) {
  const suscripcion = await mcpClient.createFlowSubscription({
    amount: 85000,  // Monto fijo mensual
    customer_email: residente.email,
    plan_id: 'gasto-comun-mensual',
    url_return: 'https://comunigestor.com/subscription-success',
    metadata: {
      unit_id: unidadId,
      auto_payment: true,
    },
  });

  // Flow cobra autom√°ticamente cada mes
  // Nunca m√°s moroso
  // Actualizaci√≥n autom√°tica de balances
}
```

**Beneficios:**
- ‚úÖ 0% morosidad para residentes suscritos
- ‚úÖ Flujo de caja predecible
- ‚úÖ Sin trabajo manual del administrador
- ‚úÖ Renovaci√≥n autom√°tica

---

#### **C. Pago de Gastos Extraordinarios**

```typescript
// Administrador crea gasto extraordinario
// Residentes reciben notificaci√≥n y pueden pagar online
async function pagarGastoExtraordinario(gastoId) {
  const gasto = await getGasto(gastoId);

  const pago = await mcpClient.createFlowPayment({
    amount: gasto.montoProrrateado,
    subject: `Gasto Extraordinario: ${gasto.descripcion}`,
    customer_email: residente.email,
    payment_method: 4,  // Todos los m√©todos
    metadata: {
      expense_id: gastoId,
      expense_type: 'extraordinario',
    },
  });
}
```

---

### **2. üîê Sistema de Autenticaci√≥n (OPCIONAL - MIGRACI√ìN)**

**Situaci√≥n actual:**
- Ya tienen JWT propio en Django

**Opci√≥n A: Mantener actual** ‚úÖ RECOMENDADO
- No migrar, seguir con Django JWT
- MCP solo para pagos y emails

**Opci√≥n B: Migrar al MCP**
- Centralizar autenticaci√≥n en MCP
- Multi-tenant (si gestionan m√∫ltiples edificios como SaaS)
- Verificaci√≥n de email
- Recuperaci√≥n de contrase√±a

```typescript
// Solo si deciden migrar
await authClient.register({
  email: 'residente@edificio.cl',
  password: 'Secure123',
  full_name: 'Juan P√©rez',
  tenant: 'edificio-los-robles',  // Multi-edificio
});
```

**Recomendaci√≥n:** **NO migrar autenticaci√≥n**. Mantener la que tienen.

---

### **3. üìß Sistema de Notificaciones y Emails (ETAPA 3)**

**Problema que resuelve:**
- Enviar estados de cuenta mensuales
- Notificar gastos extraordinarios
- Recordatorios de morosidad
- Avisos de reuniones de comit√©

**Soluci√≥n con MCP:**

#### **A. Estados de Cuenta Mensuales**

```typescript
// Enviar estado de cuenta a todos los residentes
async function enviarEstadosCuenta(comunidadId, mes) {
  const unidades = await getUnidadesComunidad(comunidadId);

  for (const unidad of unidades) {
    const estadoCuenta = await generarEstadoCuenta(unidad.id, mes);

    await mcpClient.sendEmail({
      to_email: unidad.owner.email,
      subject: `Estado de Cuenta ${mes} - Unidad ${unidad.number}`,
      html_content: renderEstadoCuentaHTML(estadoCuenta),
      metadata: {
        unit_id: unidad.id,
        month: mes,
        tipo: 'estado_cuenta',
      },
    });
  }
}
```

#### **B. Notificaci√≥n de Nuevos Gastos**

```typescript
// Administrador crea gasto ‚Üí Notificaci√≥n autom√°tica
async function notificarNuevoGasto(gastoId) {
  const gasto = await getGasto(gastoId);
  const unidades = gasto.unidades;

  for (const unidad of unidades) {
    await mcpClient.sendEmail({
      to_email: unidad.owner.email,
      subject: `Nuevo Gasto Com√∫n - ${gasto.mes}`,
      html_content: `
        <h1>Nuevo Gasto Registrado</h1>
        <p>Hola ${unidad.owner.name},</p>
        <p>Se ha registrado un nuevo gasto para tu unidad:</p>
        <ul>
          <li>Tipo: ${gasto.tipo}</li>
          <li>Monto: $${gasto.monto.toLocaleString()} CLP</li>
          <li>Fecha vencimiento: ${gasto.fechaVencimiento}</li>
        </ul>
        <a href="https://comunigestor.com/pagar/${gastoId}">Pagar Online</a>
      `,
    });
  }
}
```

#### **C. Recordatorios de Morosidad**

```typescript
// Cada semana, enviar recordatorio a morosos
async function recordatorioMorosos() {
  const unidadesMorosas = await getUnidadesMorosas();

  for (const unidad of unidadesMorosas) {
    await mcpClient.sendEmail({
      to_email: unidad.owner.email,
      subject: '‚ö†Ô∏è Recordatorio de Pago Pendiente',
      html_content: `
        <h2>Estimado/a ${unidad.owner.name}</h2>
        <p>Tu unidad ${unidad.number} tiene un saldo pendiente de:</p>
        <h3 style="color: red;">$${unidad.balance.toLocaleString()} CLP</h3>
        <p>Por favor regulariza tu situaci√≥n para evitar intereses.</p>
        <a href="https://comunigestor.com/pagar">Pagar Ahora</a>
      `,
    });
  }
}
```

#### **D. Convocatorias a Reuniones**

```typescript
async function convocarReunion(reunionId) {
  const reunion = await getReunion(reunionId);
  const propietarios = await getPropietariosComunidad(reunion.communityId);

  for (const propietario of propietarios) {
    await mcpClient.sendEmail({
      to_email: propietario.email,
      subject: `Convocatoria Reuni√≥n de Propietarios - ${reunion.fecha}`,
      html_content: `
        <h1>Reuni√≥n de Propietarios</h1>
        <p><strong>Fecha:</strong> ${reunion.fecha}</p>
        <p><strong>Hora:</strong> ${reunion.hora}</p>
        <p><strong>Lugar:</strong> ${reunion.lugar}</p>
        <h3>Tabla:</h3>
        <ol>
          ${reunion.temas.map(t => `<li>${t}</li>`).join('')}
        </ol>
      `,
    });
  }
}
```

**Beneficios:**
- ‚úÖ Emails transaccionales autom√°ticos
- ‚úÖ Templates HTML profesionales
- ‚úÖ Env√≠o masivo eficiente
- ‚úÖ Audit log de todos los env√≠os
- ‚úÖ Reduce trabajo manual del administrador

---

### **4. üåê Portal de Residentes (ETAPA 10)**

**Integraci√≥n completa:**

```typescript
// Residente inicia sesi√≥n en portal
// Puede:

// A. Ver su estado de cuenta
const estadoCuenta = await fetch('/api/units/my-account', {
  headers: { 'Authorization': `Bearer ${token}` }
});

// B. Pagar online
await mcpClient.createFlowPayment({...});

// C. Descargar comprobantes
const comprobante = await fetch('/api/payments/receipt/123');

// D. Ver historial de pagos
const historial = await fetch('/api/payments/history');

// E. Configurar pago autom√°tico
await mcpClient.createFlowSubscription({...});
```

---

### **5. üì± Notificaciones Push (ETAPA 10)**

**Webhook de MCP ‚Üí Trigger notificaci√≥n:**

```typescript
// Cuando se recibe webhook de pago exitoso de Flow
app.post('/webhooks/flow', async (req, res) => {
  const { payment_id, unit_id, amount } = req.body;

  // 1. Actualizar balance en Comunigestor
  await updateUnitBalance(unit_id, amount);

  // 2. Enviar notificaci√≥n push al residente
  await sendPushNotification(unit_id, {
    title: '‚úÖ Pago Confirmado',
    body: `Tu pago de $${amount} ha sido confirmado`,
  });

  // 3. Enviar email de confirmaci√≥n
  await mcpClient.sendPaymentConfirmation(...);

  res.status(200).send('OK');
});
```

---

### **6. üìÑ Generaci√≥n de Documentos (ETAPA 7)**

**MCP + Comunigestor:**

```typescript
// Generar certificados de deuda/no deuda
async function generarCertificado(unidadId, tipo) {
  const unidad = await getUnidad(unidadId);
  const estadoCuenta = await getEstadoCuenta(unidadId);

  // Generar PDF (en Comunigestor backend)
  const pdf = await generateCertificadoPDF(unidad, estadoCuenta, tipo);

  // Enviar por email v√≠a MCP
  await mcpClient.sendEmail({
    to_email: unidad.owner.email,
    subject: `Certificado de ${tipo}`,
    html_content: '<p>Adjunto encontrar√°s tu certificado</p>',
    attachments: [{
      filename: `certificado-${tipo}.pdf`,
      content: pdf,
    }],
  });
}
```

---

### **7. üé´ Sistema de Tickets de Soporte (ETAPA 9)**

```typescript
// Residente crea ticket
async function crearTicket(unidadId, asunto, descripcion) {
  const ticket = await createTicket({
    unit_id: unidadId,
    subject: asunto,
    description: descripcion,
    status: 'abierto',
  });

  // Notificar al administrador v√≠a MCP
  await mcpClient.sendEmail({
    to_email: 'admin@edificio.cl',
    subject: `Nuevo Ticket #${ticket.id}: ${asunto}`,
    html_content: `
      <h2>Nuevo Ticket de Soporte</h2>
      <p><strong>Unidad:</strong> ${ticket.unit.number}</p>
      <p><strong>Propietario:</strong> ${ticket.unit.owner.name}</p>
      <p><strong>Asunto:</strong> ${asunto}</p>
      <p><strong>Descripci√≥n:</strong> ${descripcion}</p>
      <a href="https://comunigestor.com/admin/tickets/${ticket.id}">Ver Ticket</a>
    `,
  });

  // Confirmar recepci√≥n al residente
  await mcpClient.sendEmail({
    to_email: ticket.unit.owner.email,
    subject: `Ticket #${ticket.id} Recibido`,
    html_content: `
      <p>Hemos recibido tu solicitud. Te responderemos pronto.</p>
      <p>N√∫mero de ticket: #${ticket.id}</p>
    `,
  });
}
```

---

### **8. üìä Reportes Financieros (ETAPA 2-3)**

```typescript
// Enviar reporte mensual al comit√©
async function enviarReporteMensual(comunidadId, mes) {
  const stats = await getEstadisticasMensuales(comunidadId, mes);

  await mcpClient.sendEmail({
    to_email: 'comite@edificio.cl',
    subject: `Reporte Financiero ${mes}`,
    html_content: `
      <h1>Reporte Mensual - ${mes}</h1>
      <h3>Ingresos</h3>
      <ul>
        <li>Gastos comunes cobrados: $${stats.gastosComunes}</li>
        <li>Pagos recibidos: $${stats.pagosRecibidos}</li>
        <li>Tasa de cobro: ${stats.tasaCobro}%</li>
      </ul>
      <h3>Morosidad</h3>
      <ul>
        <li>Unidades morosas: ${stats.unidadesMorosas}</li>
        <li>Monto moroso: $${stats.montoMoroso}</li>
      </ul>
      <h3>Gastos</h3>
      <ul>
        <li>Servicios: $${stats.servicios}</li>
        <li>Mantenci√≥n: $${stats.mantencion}</li>
        <li>Personal: $${stats.personal}</li>
      </ul>
    `,
  });
}
```

---

### **9. üîî Alertas Autom√°ticas**

```typescript
// Sistema de alertas basado en condiciones

// A. Alerta de morosidad cr√≠tica
async function alertarMorosidadCritica() {
  const stats = await getCommunityStats(comunidadId);

  if (stats.tasaMorosidad > 30) {
    await mcpClient.sendEmail({
      to_email: 'comite@edificio.cl',
      subject: '‚ö†Ô∏è ALERTA: Morosidad Cr√≠tica',
      html_content: `
        <h2 style="color: red;">Alerta de Morosidad</h2>
        <p>La tasa de morosidad ha alcanzado ${stats.tasaMorosidad}%</p>
        <p>Unidades morosas: ${stats.unidadesMorosas}</p>
        <p>Monto total: $${stats.montoMoroso}</p>
        <p><strong>Acci√≥n requerida:</strong> Gestionar cobro urgente</p>
      `,
    });
  }
}

// B. Alerta de saldo banco bajo
async function alertarSaldoBajo() {
  const saldo = await getBankBalance(comunidadId);

  if (saldo < 500000) {
    await mcpClient.sendEmail({
      to_email: 'admin@edificio.cl',
      subject: '‚ö†Ô∏è Saldo Bancario Bajo',
      html_content: `
        <p>El saldo de la cuenta est√° bajo: $${saldo}</p>
        <p>Se recomienda gestionar cobranza.</p>
      `,
    });
  }
}
```

---

### **10. üè¶ Pago a Proveedores (ETAPA 10)**

```typescript
// Automatizar notificaci√≥n de pago a proveedores
async function notificarPagoProveedor(proveedorId, monto, concepto) {
  const proveedor = await getProveedor(proveedorId);

  await mcpClient.sendEmail({
    to_email: proveedor.email,
    subject: `Pago Programado - ${concepto}`,
    html_content: `
      <h2>Notificaci√≥n de Pago</h2>
      <p>Estimado ${proveedor.nombre},</p>
      <p>Se ha programado un pago por $${monto} CLP</p>
      <p>Concepto: ${concepto}</p>
      <p>Fecha estimada: ${fechaPago}</p>
    `,
  });
}
```

---

### **11. üìÖ Reservas de Espacios Comunes (ETAPA 8)**

```typescript
// Confirmaci√≥n de reserva
async function confirmarReserva(reservaId) {
  const reserva = await getReserva(reservaId);

  await mcpClient.sendEmail({
    to_email: reserva.unit.owner.email,
    subject: `Reserva Confirmada - ${reserva.espacio}`,
    html_content: `
      <h2>‚úÖ Reserva Confirmada</h2>
      <p><strong>Espacio:</strong> ${reserva.espacio}</p>
      <p><strong>Fecha:</strong> ${reserva.fecha}</p>
      <p><strong>Hora:</strong> ${reserva.horaInicio} - ${reserva.horaFin}</p>
      <p><strong>Costo:</strong> $${reserva.costo} CLP</p>
      <a href="https://comunigestor.com/pagar-reserva/${reservaId}">Pagar Online</a>
    `,
  });
}

// Pago de reserva
async function pagarReserva(reservaId) {
  const reserva = await getReserva(reservaId);

  const pago = await mcpClient.createFlowPayment({
    amount: reserva.costo,
    subject: `Reserva ${reserva.espacio} - ${reserva.fecha}`,
    customer_email: reserva.unit.owner.email,
    metadata: {
      reservation_id: reservaId,
      payment_type: 'reserva',
    },
  });
}
```

---

### **12. üí¨ WhatsApp Bot (ETAPA 10)**

**Trigger emails desde WhatsApp:**

```typescript
// Bot de WhatsApp env√≠a recordatorio
// Usa MCP para enviar email formal

async function handleWhatsAppCommand(message) {
  if (message.text === '/estado-cuenta') {
    const unidad = await getUnidadByPhone(message.from);

    // Enviar por email detallado
    await mcpClient.sendEmail({
      to_email: unidad.owner.email,
      subject: 'Estado de Cuenta Solicitado',
      html_content: renderEstadoCuenta(unidad),
    });

    // Responder por WhatsApp
    await sendWhatsAppMessage(message.from,
      '‚úÖ He enviado tu estado de cuenta a tu email'
    );
  }
}
```

---

### **13. üìà Analytics y KPIs (ETAPA 3)**

```typescript
// Enviar reporte semanal de KPIs al comit√©
async function reporteKPISemanal() {
  const kpis = await calculateKPIs(comunidadId);

  await mcpClient.sendEmail({
    to_email: 'comite@edificio.cl',
    subject: 'Reporte Semanal de KPIs',
    html_content: `
      <h1>Dashboard Semanal</h1>
      <table>
        <tr><td>Tasa de cobro:</td><td>${kpis.tasaCobro}%</td></tr>
        <tr><td>Morosidad:</td><td>${kpis.morosidad}%</td></tr>
        <tr><td>Ingresos semana:</td><td>$${kpis.ingresos}</td></tr>
        <tr><td>Gastos semana:</td><td>$${kpis.gastos}</td></tr>
        <tr><td>Tickets abiertos:</td><td>${kpis.ticketsAbiertos}</td></tr>
      </table>
    `,
  });
}
```

---

## üîÑ Flujos Completos de Integraci√≥n

### **Flujo 1: Pago de Gasto Com√∫n**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           FLUJO: RESIDENTE PAGA GASTO COM√öN                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. Administrador crea gasto com√∫n del mes en Comunigestor
   ‚îÇ
   ‚ñº
2. Comunigestor ‚Üí MCP: Enviar emails a todos los residentes
   "Nuevo gasto com√∫n: $85.000 - Pagar antes del 05/12"
   ‚îÇ
   ‚ñº
3. Residente abre email ‚Üí Click "Pagar Online"
   ‚îÇ
   ‚ñº
4. Comunigestor ‚Üí MCP /payments/flow/create
   Body: { amount: 85000, unit_id: 102 }
   ‚îÇ
   ‚ñº
5. MCP ‚Üí Flow.cl: Crear orden de pago
   ‚Üê Flow retorna payment_url
   ‚îÇ
   ‚ñº
6. Residente redirigido a Flow ‚Üí Paga con Webpay
   ‚îÇ
   ‚ñº
7. Flow ‚Üí MCP webhook: Pago exitoso
   ‚îÇ
   ‚ñº
8. MCP ‚Üí Comunigestor webhook: Actualizar balance
   - Unit 102: balance -= 85000
   - Status: "moroso" ‚Üí "al_d√≠a"
   ‚îÇ
   ‚ñº
9. Comunigestor ‚Üí MCP: Enviar email confirmaci√≥n
   "‚úÖ Pago confirmado - $85.000 CLP"
   ‚îÇ
   ‚ñº
10. Residente recibe comprobante digital ‚úÖ
```

---

### **Flujo 2: Configurar Pago Autom√°tico**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        FLUJO: D√âBITO AUTOM√ÅTICO DE GASTOS COMUNES            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. Residente ‚Üí Portal: "Activar d√©bito autom√°tico"
   ‚îÇ
   ‚ñº
2. Comunigestor ‚Üí MCP /payments/flow/subscription/create
   Body: {
     amount: 85000,
     plan_id: "gasto-comun-mensual-edificio-los-robles",
     customer_email: "residente@gmail.com"
   }
   ‚îÇ
   ‚ñº
3. MCP ‚Üí Flow: Crear suscripci√≥n
   ‚Üê Flow retorna payment_url para primer pago
   ‚îÇ
   ‚ñº
4. Residente paga PRIMER mes en Flow
   - Flow guarda tarjeta
   - Suscripci√≥n activada
   ‚îÇ
   ‚ñº
5. CADA MES (d√≠a 1):
   Flow cobra autom√°ticamente $85.000
   ‚îÇ
   ‚ñº
6. Flow ‚Üí MCP webhook: Pago mensual exitoso
   ‚îÇ
   ‚ñº
7. MCP ‚Üí Comunigestor webhook: Actualizar balance
   - Unit 102: balance -= 85000
   ‚îÇ
   ‚ñº
8. Comunigestor ‚Üí MCP: Enviar email
   "‚úÖ Pago autom√°tico procesado - $85.000"
   ‚îÇ
   ‚ñº
9. Residente NUNCA m√°s moroso ‚úÖ
```

---

## üí∞ Modelo de Precios Sugerido

| Servicio | Implementaci√≥n | Valor |
|----------|----------------|-------|
| **Pago Online Gasto Com√∫n** | Flow.cl v√≠a MCP | Comisi√≥n 3.5% + IVA |
| **Suscripci√≥n Mensual** | Flow.cl v√≠a MCP | Comisi√≥n 3.5% + IVA |
| **Emails Transaccionales** | Gmail SMTP v√≠a MCP | Gratis (hasta 500/d√≠a) |
| **Notificaciones** | MCP + Gmail | Incluido |
| **Webhooks Procesados** | MCP Server | Incluido |
| **Audit Logs** | MCP Server | Incluido |

---

## üéØ Prioridades de Implementaci√≥n

### **Fase 1: Pagos Online** (ALTA PRIORIDAD)
1. ‚úÖ Configurar Flow.cl en MCP
2. ‚úÖ Crear endpoint de pago en Comunigestor
3. ‚úÖ Integrar bot√≥n "Pagar Online" en frontend
4. ‚úÖ Configurar webhooks Flow ‚Üí MCP ‚Üí Comunigestor
5. ‚úÖ Testing en sandbox Flow
6. ‚úÖ Deploy a producci√≥n

**Tiempo estimado:** 1-2 semanas
**Impacto:** üöÄüöÄüöÄ Alt√≠simo (reduce morosidad)

---

### **Fase 2: Emails Autom√°ticos** (ALTA PRIORIDAD)
1. ‚úÖ Configurar Gmail SMTP en MCP
2. ‚úÖ Crear templates de emails
3. ‚úÖ Integrar env√≠o de estados de cuenta
4. ‚úÖ Recordatorios de morosidad
5. ‚úÖ Notificaciones de nuevos gastos

**Tiempo estimado:** 1 semana
**Impacto:** üöÄüöÄ Alto (mejora comunicaci√≥n)

---

### **Fase 3: Suscripciones/D√©bito Autom√°tico** (MEDIA PRIORIDAD)
1. ‚úÖ Crear planes en Flow.cl
2. ‚úÖ Implementar opci√≥n de suscripci√≥n
3. ‚úÖ Panel de gesti√≥n de suscripciones
4. ‚úÖ Cancelaci√≥n de suscripciones

**Tiempo estimado:** 1-2 semanas
**Impacto:** üöÄüöÄüöÄ Alt√≠simo (0% morosidad)

---

### **Fase 4: Portal de Residentes** (BAJA PRIORIDAD)
1. Portal p√∫blico
2. Login de residentes
3. Ver estado de cuenta
4. Historial de pagos
5. Descargar comprobantes

**Tiempo estimado:** 2-3 semanas
**Impacto:** üöÄ Medio

---

## ‚úÖ Beneficios del MCP Server

| Beneficio | Sin MCP | Con MCP |
|-----------|---------|---------|
| **Desarrollo pagos online** | 4-6 semanas | ‚úÖ 1-2 semanas |
| **Mantenimiento Flow.cl** | Alta complejidad | ‚úÖ Simplificado |
| **Emails transaccionales** | Desarrollar todo | ‚úÖ API calls |
| **Webhooks** | Implementar + testing | ‚úÖ Incluido |
| **Audit logs** | Desarrollar | ‚úÖ Autom√°tico |
| **Multi-edificio** | Duplicar c√≥digo | ‚úÖ Multi-tenant |
| **Credenciales seguras** | En c√≥digo | ‚úÖ En MCP |

---

## üìã Checklist de Implementaci√≥n

### **Setup Inicial**
- [ ] MCP Server corriendo (local o Render)
- [ ] Credenciales Flow.cl obtenidas
- [ ] Gmail SMTP configurado
- [ ] Variables de entorno en MCP

### **Pagos Online**
- [ ] Crear endpoint `/api/payments/flow/create` en Comunigestor
- [ ] Agregar bot√≥n "Pagar Online" en frontend
- [ ] Configurar webhooks Flow ‚Üí MCP
- [ ] Testing en sandbox
- [ ] Deploy a producci√≥n

### **Emails**
- [ ] Copiar cliente email a Comunigestor
- [ ] Crear templates de emails
- [ ] Implementar env√≠o de estados de cuenta
- [ ] Implementar recordatorios
- [ ] Testing

### **Suscripciones** (Opcional)
- [ ] Crear planes en Flow.cl
- [ ] Implementar UI de suscripci√≥n
- [ ] Panel de gesti√≥n
- [ ] Testing

---

## üìö Recursos para Comunigestor

- **FLOW_CHILE_GUIDE.md** - Integraci√≥n Flow.cl
- **EMAIL_GUIDE.md** - Sistema de emails
- **AUTH_GUIDE.md** - Autenticaci√≥n (si migran)
- **API Docs MCP** - http://localhost:8000/docs

---

## üéâ Resumen

**El MCP Server puede potenciar Comunigestor en:**

1. ‚úÖ **Pagos Online** (Flow.cl) - Reduce morosidad 50-80%
2. ‚úÖ **Suscripciones** (D√©bito autom√°tico) - Elimina morosidad
3. ‚úÖ **Emails Autom√°ticos** - Estados de cuenta, recordatorios
4. ‚úÖ **Notificaciones** - Nuevos gastos, reuniones, alertas
5. ‚úÖ **Portal Residentes** - Autogesti√≥n de pagos
6. ‚úÖ **Reportes** - KPIs autom√°ticos al comit√©
7. ‚úÖ **Tickets** - Notificaciones de soporte
8. ‚úÖ **Reservas** - Pago de espacios comunes
9. ‚úÖ **WhatsApp Bot** - Integraci√≥n con emails
10. ‚úÖ **Proveedores** - Notificaciones de pago

**Impacto estimado:**
- üìâ Morosidad: -60% a -80%
- ‚è±Ô∏è Tiempo administrador: -70%
- üí∞ Flujo de caja: +300% previsibilidad
- üòä Satisfacci√≥n residentes: +90%

**¬°Comunigestor + MCP Server = Sistema Profesional Completo!** üè¢‚ú®
